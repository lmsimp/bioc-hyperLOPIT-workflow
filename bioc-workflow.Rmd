---
title: "A Bioconductor Workflow for Processing and Analysing Spatial Proteomics Data"
author: "Lisa Breckels"
date: "11 May 2016"
output: html_document
---

# Forward

Quantitative mass spectrometry based spatial proteomics involves elaborate, expensive and time consuming experimental procedures and considerable effort is invested in the generation of such data. Multiple research groups have described a variety of approaches to establish high quality proteome-wide datasets. However, data analysis is as critical as data production for reliable and insightful biological interpretation. Here, we walk through a typical pipeline for the analysis of such data using the Bioconductor `pRoloc` package for the R statistical programming environment. 

# Reading and handling mass-spectrometry based proteomics data

## The use-case: prediction sub-cellular localisation in pluripotent embroyonic mouse stem cells

As a use-case we analyse a recent high-throughput spatial proteomics dataset from pluripotent mouse embryonic stem cells (E14TG2a) [@hyper]. The data was generated using hyperplexed LOPIT (hyperLOPIT), a novel technique for robust classification of protein localisation across the whole cell. The method uses an elaborate sub-cellular fractionation scheme, enabled by the use of Tandem Mass Tag (TMT) 10-plex and application of the MS data acquisition technique named synchronous precursor selection MS^3 (SPS)-MS^3 [@McAlister:2014], for TMT quantification with high accuracy and precision. Three biological replicates were generated from the E14TG2a experiment, the first was to target low density fractions and the second and third were to emphasis seperation of the denser organelles. The intersect of replicates 1 and 2 was treated as a 20-plex dataset for the analysis discussed in the manuscipt [@hyper] as it has been shown that combining replicates across from different gradients can increase spatial resolution [@trotter]. The combination of replicates resulted in 5032 proteins common in both experiments. Before combination, the two replicates were separately normalised by sum across the 10 channels (i.e. such that the sum of each protein's intensity is 1), for each replicate respectively. Normalisation is an essential part of data processing and several methods are available in `MSnbase`. The combination of data can also be performed effectively in `MSnbase` as detailed in the dedicated 'Combining MSnSet instances' section of the [`MSnbase` tutorial vignette](http://bioconductor.org/packages/release/bioc/vignettes/MSnbase/inst/doc/MSnbase-demo.pdf). 

## The infrastructre: pRoloc and MSnbase in Bioconductor

To make use of the full functionailty of the `pRoloc` software one is required to import their data into R as a `MSnSet` instance. The `MSnSet` is a dedicated data structure for the efficient manipulation and processing of mass spectrometry and proteomics data in R. Figure 1 illustrates a simplified view of the `MSnSet` structure; there exists 3 key slots (1) the `exprs` slot for storing the quantitation data, (2) the `fData` slot for storing the feature meta-data, and finally (3) the `pData` slot for storing the sample meta-data. 
![**Figure 1.** Simplified representation of the `MSnSet` data structure (reproduced with permission from the `MSnbase` vignette)](./Figures/msnset.png)

There are a number of ways to import quantitation data and create a `MSnSet` instance and all methods are described in the [`MSnbase` input/ouput capabilities vignette](http://bioconductor.org/packages/release/bioc/vignettes/MSnbase/inst/doc/MSnbase-io.pdf). One suggested simple method is to use the function `readMSnSet2` in `MSnbase`. The function takes a single spreadsheet as input and extracts the columns containing the quantitation data, as identified by the argument `ecol`, to create the expression data, while the other columns in the spreadsheet are appeneded to the feature meta-data slot. 
By example, in the code chunk below we read in the `csv` speadsheet containing the quantitation data from the intersect of replicates 1 and 2 of the mouse map [@hyper], using the `readMSnSet2` function. The data is as available online with the manuscipt (see tab 2 of the `xlsx` supplementary data set 1 in [@hyper]) and also as both a `csv` and `MSnSet` object in the Bioconductor `pRolocdata` data package. 

To use the `readMSnSet2` function, as a minimum one must specify the file path to the data and which columns of the spreadsheet contain quantitation data. The `getEcols` function exists to help users identify which columns of the spreadsheet that contain the quantitation data. The spreadsheet of E14TG2a data; "hyperLOPIT-SIData-ms3-rep12-intersect.csv", contains 5032 proteins common across the 2 biological replicates for the respective 2 x 10-plex reporter tags, along with assoiated feature meta-data such as protein markers, protein description, number of quantified peptides etc. The spreadsheet contains two headers, with the second header containing information about where the quantitation data is stored. We can display the names of the second header by calling the `getEcols` function with the argument `n = 2`, to specify that we wish to display the column names of the second header. It is now easy for one to identify that the quantitation data is located in columns 8 to 27. It is also possible to pass the optional argument `fnames` to indicate which column to use as the labels by which to identify each protein in the sample. Here, we use `fnames = 1` to use the Uniprot identifiers contained in the first column of the speadsheet.


```{r makeMSnSet, echo=FALSE, message=FALSE, warning=FALSE}
library("MSnbase")

f0 <- dir(system.file("extdata", package = "pRolocdata"), full.names = TRUE, 
          pattern = "hyperLOPIT-SIData-ms3-rep12-intersect.csv")

getEcols(f0, split = ",", n = 2)

lopit2015 <- readMSnSet2(f0, ecol = c(8:27), fnames = 1, skip = 1)

## Note: arguments can be passed to read.table and friends using ...
## here we use skip = 1 to tell readMSnSet2 to skip 1 line before
## beginning to read data.

## Examine the quantitative information for first 5 proteins 
exprs(lopit2015)[1:5, ]
```

As briefly mentioned above, the quantitation data is stored in the `exprs` slot of the `MSnSet` and can be accessed by `exprs(lopit2015)`. The feature meta-data is stored in the `fData` slot and can be accessed by `fData(lopit2015)`. When using `readMSnSet2`, automatically, everything that is not defined as quantitation data by `ecol` or the fetaure names by `fnames` is deposited to the `fData` slot. As we wish to demonstrate the complete analysis of this data we remove the results from the prior analysis described in [@hyper] in the code chunk below. We see the `fData` contains 25 columns describing information such as the number of peptides, associated markers, machine learning results etc. For demonstration in the code chunk below keep the two columns "phenoDisco.Input" and "SVM.marker.set" that contain two protein marker sets to use an input for machine learning analyses.

```{r removefData}
fvarLabels(lopit2015)
fData(lopit2015) <- fData(lopit2015)[, c("phenoDisco.Input", "SVM.marker.set")]
head(fData(lopit2015))
```


# Normalisation and Quality Control

# Markers

# Novelty Detection

# Supervised machine learning

